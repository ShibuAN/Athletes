<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Activities - Athletes</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .activities-container {
            padding-top: calc(var(--header-height) + 2rem);
            padding-bottom: 4rem;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s;
        }

        .activity-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .activity-info h4 {
            margin: 0;
            color: var(--text-main);
        }

        .activity-info p {
            margin: 0.2rem 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .activity-stats {
            text-align: right;
        }

        .stat-main {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .month-header {
            color: var(--secondary);
            font-size: 1.1rem;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }
    </style>
</head>

<body>
    <div class="bg-glow"></div>

    <nav class="navbar">
        <a href="index.html" class="nav-logo">ATHLETES</a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="events.html" class="nav-link">Events</a>
            <a href="leaderboard.html" class="nav-link">Leaderboard</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="#" id="logoutBtn" class="nav-link">Logout</a>
        </div>
    </nav>

    <div class="container activities-container">
        <div class="glass-card">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 class="text-gradient" style="font-size: 2.5rem;">All Activities</h2>
                <a href="dashboard.html" class="btn btn-outline btn-sm">Back to Dashboard</a>
            </header>

            <div class="filters-row"
                style="display: flex; gap: 1.5rem; align-items: center; margin-bottom: 3rem; padding: 1.5rem; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--border);">
                <div class="filter-group">
                    <label
                        style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; display: block; font-weight: 500;">Month</label>
                    <select id="monthFilter" class="form-input filter-select"
                        style="width: 180px; height: 48px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;">
                        <option value="all">All Months</option>
                        <option value="0">January</option>
                        <option value="1">February</option>
                        <option value="2">March</option>
                        <option value="3">April</option>
                        <option value="4">May</option>
                        <option value="5">June</option>
                        <option value="6">July</option>
                        <option value="7">August</option>
                        <option value="8">September</option>
                        <option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11">December</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label
                        style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; display: block; font-weight: 500;">Year</label>
                    <select id="yearFilter" class="form-input filter-select"
                        style="width: 140px; height: 48px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;">
                        <option value="all">All Years</option>
                    </select>
                </div>
            </div>

            <style>
                .filter-select {
                    background: rgba(255, 255, 255, 0.05) !important;
                    border: 1px solid var(--border) !important;
                    color: var(--text-main) !important;
                }

                .filter-select:hover {
                    border-color: var(--primary) !important;
                    color: var(--primary) !important;
                    background: rgba(234, 88, 12, 0.05) !important;
                    transform: translateY(-2px);
                }

                .filter-select option {
                    background: var(--bg-dark);
                    color: var(--text-main);
                }
            </style>

            <div id="fullActivityList">
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    Loading your activities...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin></script>
    <script src="js/supabase.js"></script>
    <script src="js/script.js?v=1.7"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const supabase = window.supabaseClient;
            const listEl = document.getElementById('fullActivityList');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            const user = localStorage.getItem('user');

            let allActivities = [];

            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            async function loadAllActivities() {
                try {
                    const { data: acts, error } = await supabase
                        .from('strava_activities')
                        .select('*')
                        .eq('user_email', user)
                        .order('start_date', { ascending: false });

                    if (error) throw error;

                    allActivities = acts || [];

                    // Populate years
                    const years = [...new Set(allActivities.map(a => new Date(a.start_date).getFullYear()))].sort((a, b) => b - a);
                    years.forEach(year => {
                        const opt = document.createElement('option');
                        opt.value = year;
                        opt.textContent = year;
                        yearFilter.appendChild(opt);
                    });

                    renderActivities();
                } catch (err) {
                    console.error('Error loading activities:', err);
                    listEl.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 2rem;">Error loading your activities.</div>';
                }
            }

            function renderActivities() {
                const selectedMonth = monthFilter.value;
                const selectedYear = yearFilter.value;

                const filtered = allActivities.filter(act => {
                    const date = new Date(act.start_date);
                    const matchMonth = selectedMonth === 'all' || date.getMonth().toString() === selectedMonth;
                    const matchYear = selectedYear === 'all' || date.getFullYear().toString() === selectedYear;
                    return matchMonth && matchYear;
                });

                if (filtered.length > 0) {
                    // Group by Month Year for display
                    const grouped = {};
                    filtered.forEach(act => {
                        const date = new Date(act.start_date);
                        const monthYear = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                        if (!grouped[monthYear]) grouped[monthYear] = [];
                        grouped[monthYear].push(act);
                    });

                    let html = '';
                    Object.keys(grouped).forEach(month => {
                        html += `<h3 class="month-header">${month}</h3>`;
                        html += grouped[month].map(act => `
                            <div class="activity-item">
                                <div class="activity-info">
                                    <h4>${act.name || act.type}</h4>
                                    <p>${act.type} â€¢ ${new Date(act.start_date).toLocaleDateString()} at ${new Date(act.start_date).toLocaleTimeString()}</p>
                                </div>
                                <div class="activity-stats">
                                    <div class="stat-main">${(act.distance / 1000).toFixed(2)} km</div>
                                    <div class="stat-sub">${Math.floor(act.moving_time / 60)}m ${act.moving_time % 60}s</div>
                                </div>
                            </div>
                        `).join('');
                    });
                    listEl.innerHTML = html;
                } else {
                    listEl.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-muted);">No activities found for the selected period.</div>';
                }
            }

            monthFilter.addEventListener('change', renderActivities);
            yearFilter.addEventListener('change', renderActivities);

            await loadAllActivities();
        });
    </script>
</body>

</html>